<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MKV Cleaner - Web Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <div class="container">
      <h1>üé¨ MKV Cleaner - Web Interface</h1>

      <div class="nav">
        <a href="/">Home</a>
        <a href="/config">‚öôÔ∏è Edit Paths</a>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="alert alert-{{ 'success' if category == 'success' else 'error' }}"
      >
        {{ message }}
      </div>
      {% endfor %} {% endif %} {% endwith %}

      <div class="section">
        <h2>Current Configuration</h2>
        <div class="config-info">
          <p><strong>MKV Folder:</strong> {{ config.MKV_FOLDER }}</p>
          <p>
            <strong>Allowed Audio Languages:</strong> {{
            config.ALLOWED_AUDIO_LANGS | join(', ') }}
          </p>
          <p>
            <strong>Allowed Subtitle Languages:</strong> {{
            config.ALLOWED_SUB_LANGS | join(', ') }}
          </p>
          <p><strong>Default Audio:</strong> {{ config.DEFAULT_AUDIO_LANG }}</p>
          <p>
            <strong>Default Subtitle:</strong> {{ config.DEFAULT_SUBTITLE_LANG
            }}
          </p>
        </div>
      </div>

      <div class="section">
        <h2>Language Settings</h2>
        <form method="POST" action="/update_settings">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
            <div>
              <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #34495e;">Allowed Audio Languages:</label>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="audio_eng" name="allowed_audio_langs" value="eng"
                         {{ 'checked' if 'eng' in config.ALLOWED_AUDIO_LANGS else '' }}>
                  <label for="audio_eng">English (eng)</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="audio_ger" name="allowed_audio_langs" value="ger"
                         {{ 'checked' if 'ger' in config.ALLOWED_AUDIO_LANGS else '' }}>
                  <label for="audio_ger">German (ger)</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="audio_kor" name="allowed_audio_langs" value="kor"
                         {{ 'checked' if 'kor' in config.ALLOWED_AUDIO_LANGS else '' }}>
                  <label for="audio_kor">Korean (kor)</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="audio_jpn" name="allowed_audio_langs" value="jpn"
                         {{ 'checked' if 'jpn' in config.ALLOWED_AUDIO_LANGS else '' }}>
                  <label for="audio_jpn">Japanese (jpn)</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="audio_gre" name="allowed_audio_langs" value="gre"
                         {{ 'checked' if 'gre' in config.ALLOWED_AUDIO_LANGS else '' }}>
                  <label for="audio_gre">Greek (gre)</label>
                </div>
              </div>
            </div>
            
            <div>
              <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #34495e;">Allowed Subtitle Languages:</label>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="sub_eng" name="allowed_sub_langs" value="eng"
                         {{ 'checked' if 'eng' in config.ALLOWED_SUB_LANGS else '' }}>
                  <label for="sub_eng">English (eng)</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="sub_ger" name="allowed_sub_langs" value="ger"
                         {{ 'checked' if 'ger' in config.ALLOWED_SUB_LANGS else '' }}>
                  <label for="sub_ger">German (ger)</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="sub_kor" name="allowed_sub_langs" value="kor"
                         {{ 'checked' if 'kor' in config.ALLOWED_SUB_LANGS else '' }}>
                  <label for="sub_kor">Korean (kor)</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="sub_jpn" name="allowed_sub_langs" value="jpn"
                         {{ 'checked' if 'jpn' in config.ALLOWED_SUB_LANGS else '' }}>
                  <label for="sub_jpn">Japanese (jpn)</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="sub_gre" name="allowed_sub_langs" value="gre"
                         {{ 'checked' if 'gre' in config.ALLOWED_SUB_LANGS else '' }}>
                  <label for="sub_gre">Greek (gre)</label>
                </div>
              </div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
            <div>
              <label for="default_audio_lang" style="display: block; margin-bottom: 5px; font-weight: bold; color: #34495e;">Default Audio Language:</label>
              <select id="default_audio_lang" name="default_audio_lang" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="eng" {{ 'selected' if config.DEFAULT_AUDIO_LANG == 'eng' else '' }}>English (eng)</option>
                <option value="ger" {{ 'selected' if config.DEFAULT_AUDIO_LANG == 'ger' else '' }}>German (ger)</option>
                <option value="kor" {{ 'selected' if config.DEFAULT_AUDIO_LANG == 'kor' else '' }}>Korean (kor)</option>
                <option value="jpn" {{ 'selected' if config.DEFAULT_AUDIO_LANG == 'jpn' else '' }}>Japanese (jpn)</option>
                <option value="gre" {{ 'selected' if config.DEFAULT_AUDIO_LANG == 'gre' else '' }}>Greek (gre)</option>
              </select>
            </div>
            
            <div>
              <label for="default_subtitle_lang" style="display: block; margin-bottom: 5px; font-weight: bold; color: #34495e;">Default Subtitle Language:</label>
              <select id="default_subtitle_lang" name="default_subtitle_lang" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="eng" {{ 'selected' if config.DEFAULT_SUBTITLE_LANG == 'eng' else '' }}>English (eng)</option>
                <option value="ger" {{ 'selected' if config.DEFAULT_SUBTITLE_LANG == 'ger' else '' }}>German (ger)</option>
                <option value="kor" {{ 'selected' if config.DEFAULT_SUBTITLE_LANG == 'kor' else '' }}>Korean (kor)</option>
                <option value="jpn" {{ 'selected' if config.DEFAULT_SUBTITLE_LANG == 'jpn' else '' }}>Japanese (jpn)</option>
                <option value="gre" {{ 'selected' if config.DEFAULT_SUBTITLE_LANG == 'gre' else '' }}>Greek (gre)</option>
              </select>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
            <div>
              <label for="original_audio_lang" style="display: block; margin-bottom: 5px; font-weight: bold; color: #34495e;">Original Audio Language:</label>
              <select id="original_audio_lang" name="original_audio_lang" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="eng" {{ 'selected' if config.ORIGINAL_AUDIO_LANG == 'eng' else '' }}>English (eng)</option>
                <option value="ger" {{ 'selected' if config.ORIGINAL_AUDIO_LANG == 'ger' else '' }}>German (ger)</option>
                <option value="kor" {{ 'selected' if config.ORIGINAL_AUDIO_LANG == 'kor' else '' }}>Korean (kor)</option>
                <option value="jpn" {{ 'selected' if config.ORIGINAL_AUDIO_LANG == 'jpn' else '' }}>Japanese (jpn)</option>
                <option value="gre" {{ 'selected' if config.ORIGINAL_AUDIO_LANG == 'gre' else '' }}>Greek (gre)</option>
              </select>
            </div>
            
            <div>
              <label for="original_subtitle_lang" style="display: block; margin-bottom: 5px; font-weight: bold; color: #34495e;">Original Subtitle Language:</label>
              <select id="original_subtitle_lang" name="original_subtitle_lang" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="eng" {{ 'selected' if config.ORIGINAL_SUBTITLE_LANG == 'eng' else '' }}>English (eng)</option>
                <option value="ger" {{ 'selected' if config.ORIGINAL_SUBTITLE_LANG == 'ger' else '' }}>German (ger)</option>
                <option value="kor" {{ 'selected' if config.ORIGINAL_SUBTITLE_LANG == 'kor' else '' }}>Korean (kor)</option>
                <option value="jpn" {{ 'selected' if config.ORIGINAL_SUBTITLE_LANG == 'jpn' else '' }}>Japanese (jpn)</option>
                <option value="gre" {{ 'selected' if config.ORIGINAL_SUBTITLE_LANG == 'gre' else '' }}>Greek (gre)</option>
              </select>
            </div>
          </div>
          
          <div style="text-align: center;">
            <button type="submit" class="btn btn-primary">üíæ Save Language Settings</button>
          </div>
        </form>
      </div>

      <div class="section">
        <h2>MKV Files</h2>
        <button class="btn btn-primary" onclick="loadFiles()">
          üîÑ Refresh File List
        </button>
        <div id="files-container" class="files-list" style="margin-top: 15px">
          <p>Click "Refresh File List" to load files...</p>
        </div>
      </div>

      <div class="section">
        <h2>Processing</h2>
        <button
          id="start-btn"
          class="btn btn-primary"
          onclick="startProcessing()"
        >
          ‚ñ∂Ô∏è Start Processing
        </button>
        <button
          id="stop-btn"
          class="btn btn-danger"
          onclick="stopProcessing()"
          style="display: none"
        >
          ‚èπÔ∏è Stop Processing
        </button>

        <div id="progress-container" class="progress-container">
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
          </div>
          <div id="progress-text" class="progress-text">Ready to start...</div>
        </div>

        <div id="log-container" class="log-container">
          <h3>Processing Log</h3>
          <div id="log" class="log"></div>
        </div>
      </div>
    </div>

    <script>
      let statusInterval;

      function loadFiles() {
        fetch("/files")
          .then((response) => response.json())
          .then((data) => {
            const container = document.getElementById("files-container");
            if (data.error) {
              container.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
              return;
            }

            if (data.files.length === 0) {
              container.innerHTML =
                "<p>No MKV files found in the configured folder.</p>";
              return;
            }

            container.innerHTML = data.files
              .map(
                (file) => `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-name">${file.name}</div>
                                <div class="file-details">
                                    Series: ${file.series_title} | Episode: ${
                  file.season_episode
                } | 
                                    Size: ${(file.size / 1024 / 1024).toFixed(
                                      1
                                    )} MB | 
                                    Modified: ${file.modified}
                                </div>
                            </div>
                        </div>
                    `
              )
              .join("");
          })
          .catch((error) => {
            document.getElementById(
              "files-container"
            ).innerHTML = `<p style="color: red;">Error loading files: ${error.message}</p>`;
          });
      }

      function startProcessing() {
        fetch("/process", { method: "POST" })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              alert("Error: " + data.error);
              return;
            }

            document.getElementById("start-btn").style.display = "none";
            document.getElementById("stop-btn").style.display = "inline-block";
            document.getElementById("progress-container").style.display =
              "block";
            document.getElementById("log-container").style.display = "block";

            statusInterval = setInterval(updateStatus, 1000);
          })
          .catch((error) => {
            alert("Error starting processing: " + error.message);
          });
      }

      function stopProcessing() {
        fetch("/stop", { method: "POST" })
          .then((response) => response.json())
          .then((data) => {
            clearInterval(statusInterval);
            resetUI();
          });
      }

      function updateStatus() {
        fetch("/status")
          .then((response) => response.json())
          .then((status) => {
            const progressFill = document.getElementById("progress-fill");
            const progressText = document.getElementById("progress-text");
            const log = document.getElementById("log");

            if (status.total_files > 0) {
              const percentage = (status.progress / status.total_files) * 100;
              progressFill.style.width = percentage + "%";
              progressText.textContent = `Processing ${status.progress}/${status.total_files} files`;

              if (status.current_file) {
                progressText.textContent += ` - Current: ${status.current_file}`;
              }
            }

            log.innerHTML = status.log
              .map((entry) => `<div>${entry}</div>`)
              .join("");
            log.scrollTop = log.scrollHeight;

            if (!status.is_running && status.progress > 0) {
              clearInterval(statusInterval);
              resetUI();
              progressText.textContent = "Processing completed!";
            }
          });
      }

      function resetUI() {
        document.getElementById("start-btn").style.display = "inline-block";
        document.getElementById("stop-btn").style.display = "none";
      }

      // Load files on page load
      window.onload = function () {
        loadFiles();
      };
    </script>
  </body>
</html>
