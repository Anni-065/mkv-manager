<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MKV Cleaner - Configuration</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
  </head>
  <body>
    <div class="container config">
      <h1>⚙️ MKV Cleaner - Path Configuration</h1>

      <div class="nav">
        <a href="/">Home</a>
        <a href="/config">Path Configuration</a>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="alert alert-{{ 'success' if category == 'success' else 'error' }}"
      >
        {{ message }}
      </div>
      {% endfor %} {% endif %} {% endwith %}

      <form method="POST">
        <div class="config-section">
          <h2>Paths</h2>

          <div class="form-group">
            <label for="mkvmerge_path">MKVToolNix Path:</label>
            <div style="display: flex; gap: 10px; align-items: center">
              <input
                type="text"
                id="mkvmerge_path"
                name="mkvmerge_path"
                value="{{ config.MKVMERGE_PATH }}"
                required
                style="flex: 1"
              />
              <button
                type="button"
                class="btn btn-secondary"
                onclick="openFileBrowser('mkvmerge_path')"
              >
                📁 Set Folder Path
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="openExplorer('mkvmerge_path')"
              >
                🪟 Open Folder
              </button>
            </div>
            <div class="help-text">
              Path to mkvmerge.exe (usually in C:\Program Files\MKVToolNix\)
            </div>
          </div>

          <div class="form-group">
            <label for="mkv_folder">MKV Source Folder:</label>
            <div style="display: flex; gap: 10px; align-items: center">
              <input
                type="text"
                id="mkv_folder"
                name="mkv_folder"
                value="{{ config.MKV_FOLDER }}"
                required
                style="flex: 1"
              />
              <button
                type="button"
                class="btn btn-secondary"
                onclick="openFileBrowser('mkv_folder')"
              >
                📁 Set Folder Path
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="openExplorer('mkv_folder')"
              >
                🪟 Open Folder
              </button>
            </div>
            <div class="help-text">
              Folder containing the MKV files to process
            </div>
          </div>

          <div class="form-group">
            <label for="output_info">Output Folder:</label>
            <div
              style="
                padding: 10px;
                background: #e8f4f8;
                border: 1px solid #bee5eb;
                border-radius: 5px;
                color: #0c5460;
              "
            >
              📁 Processed files will be saved to:
              <strong>[MKV Source Folder]/processed/</strong>
            </div>
            <div class="help-text">
              Output folder is automatically created inside the source folder
            </div>
          </div>
        </div>

        <div style="text-align: center; margin-top: 30px">
          <button type="submit" class="btn btn-primary">
            💾 Save Path Configuration
          </button>
          <a href="/" class="btn btn-secondary">❌ Cancel</a>
        </div>
      </form>
    </div>

    <!-- File Browser Modal -->
    <div id="fileBrowserModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>📁 Browse for Folder</h3>
          <button onclick="closeFileBrowser()" class="modal-close">❌</button>
        </div>

        <div class="modal-controls">
          <select id="driveSelector" onchange="changeDrive()">
            <option value="">Loading drives...</option>
          </select>
          <button onclick="goToParentFolder()" class="btn btn-secondary">
            📁 Up
          </button>
          <button onclick="refreshCurrentFolder()" class="btn btn-secondary">
            🔄 Refresh
          </button>
        </div>

        <div style="margin-bottom: 15px">
          <strong>Current Path:</strong> <span id="currentPath"></span>
        </div>

        <div id="folderList" class="folder-list">
          <div>Loading...</div>
        </div>

        <div class="modal-footer">
          <button onclick="selectCurrentFolder()" class="btn btn-primary">
            ✅ Select This Folder
          </button>
          <button onclick="closeFileBrowser()" class="btn btn-secondary">
            ❌ Cancel
          </button>
        </div>
      </div>
    </div>

    <script>
      let currentBrowserPath = "";
      let currentInputField = "";

      function openFileBrowser(inputFieldId) {
        currentInputField = inputFieldId;
        document.getElementById("fileBrowserModal").style.display = "block";
        loadDrives();

        fetch("/get_user_home")
          .then((response) => response.json())
          .then((data) => {
            if (data.home_path) {
              browsePath(data.home_path);
            } else {
              browsePath("C:\\Users");
            }
          })
          .catch((error) => {
            console.log("Could not get user home, using default");
            browsePath("C:\\Users");
          });
      }

      function closeFileBrowser() {
        document.getElementById("fileBrowserModal").style.display = "none";
      }

      function loadDrives() {
        fetch("/get_drives")
          .then((response) => response.json())
          .then((data) => {
            const driveSelector = document.getElementById("driveSelector");
            driveSelector.innerHTML = "";

            if (data.error) {
              document.getElementById("folderList").innerHTML =
                '<div style="color: red;">Error loading drives: ' +
                data.error +
                "</div>";
              return;
            }

            data.drives.forEach((drive) => {
              const option = document.createElement("option");
              option.value = drive.path;
              option.textContent = `${drive.letter}: (${formatBytes(
                drive.free
              )} free)`;
              driveSelector.appendChild(option);
            });
            if (data.drives.length > 0) {
              changeDrive();
            }
          })
          .catch((error) => {
            console.error("Error loading drives:", error);
            document.getElementById("folderList").innerHTML =
              '<div style="color: red;">Error loading drives</div>';
          });
      }

      function formatBytes(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function changeDrive() {
        const selectedDrive = document.getElementById("driveSelector").value;
        if (selectedDrive) {
          browsePath(selectedDrive);
        }
      }

      function browsePath(path) {
        currentBrowserPath = path;
        document.getElementById("currentPath").textContent = path;

        fetch(`/browse?path=${encodeURIComponent(path)}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              document.getElementById("folderList").innerHTML =
                '<div style="color: red;">Error: ' + data.error + "</div>";
              return;
            }
            displayFolders(data.items);
          })
          .catch((error) => {
            console.error("Error browsing path:", error);
            document.getElementById("folderList").innerHTML =
              '<div style="color: red;">Error loading folders</div>';
          });
      }

      function displayFolders(items) {
        const folderList = document.getElementById("folderList");
        folderList.innerHTML = "";

        if (!items || items.length === 0) {
          folderList.innerHTML =
            '<div style="color: #666;">No folders found</div>';
          return;
        }

        items.forEach((item) => {
          const folderItem = document.createElement("div");
          folderItem.className = "folder-item";
          folderItem.innerHTML = `<span class="folder-icon">${item.icon}</span> ${item.name}`;

          if (item.type === "directory" || item.type === "parent") {
            folderItem.onclick = function () {
              browsePath(item.path);
            };
          } else {
            folderItem.style.opacity = "0.7";
            folderItem.style.cursor = "default";
          }

          folderList.appendChild(folderItem);
        });
      }

      function goToParentFolder() {
        if (currentBrowserPath) {
          const pathParts = currentBrowserPath.split("\\\\");
          if (pathParts.length > 1) {
            pathParts.pop();
            const parentPath = pathParts.join("\\\\");
            if (parentPath) {
              browsePath(parentPath);
            }
          }
        }
      }

      function refreshCurrentFolder() {
        if (currentBrowserPath) {
          browsePath(currentBrowserPath);
        }
      }

      function selectCurrentFolder() {
        if (currentBrowserPath && currentInputField) {
          document.getElementById(currentInputField).value = currentBrowserPath;
          closeFileBrowser();
        }
      }

      function openExplorer(inputFieldId) {
        const path = document.getElementById(inputFieldId).value;
        if (path) {
          fetch("/open_explorer", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ path: path }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                alert("📂 Windows Explorer opened successfully!");
              } else {
                alert("❌ Error opening Windows Explorer: " + data.error);
              }
            })
            .catch((error) => {
              console.error("Error opening explorer:", error);
              alert("❌ Error opening Windows Explorer");
            });
        } else {
          alert("⚠️ Please enter a path first");
        }
      }

      document.getElementById("fileBrowserModal").onclick = function (event) {
        if (event.target === this) {
          closeFileBrowser();
        }
      };
    </script>
  </body>
</html>
